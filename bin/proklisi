#!/usr/bin/env bash

###############################################################################@
##
## @BEGIN
##
## @COPYRIGHT BEGIN
## Copyright (C) 2020 Panos I. Papadopoulos <panos1962_AT_gmail_DOT_com>
## @COPYRIGHT END
##
## @FILETYPE BEGIN
## bash
## @FILETYPE END
##
## @FILE BEGIN
## bin/proklisi —— Πρόγραμμα γενικής διαχείρισης προ-κλήσεων.
## @FILE END
##
## @DESCRIPTION BEGIN
## Το παρόν πρόγραμμα κάνει γενική διαχείριση προ-κλήσεων. Η συνήθης διαδικασία
## που επιτελείται μέσω του συγκεκριμένου προγράμματος είναι η μορφοποίηση των
## προ-κλήσεων που διαβάζει από το standard input ή από αρχεία που καθορίζονται
## στο command line.
## @DESCRIPTION END
##
## @HISTORY BEGIN
## Created: 2020-02-26
## @HISTORY END
##
## @END
##
###############################################################################@

pd_tmpmax=1

. "${PANDORA_BASEDIR:=/var/opt/pandora}/lib/pandora.sh"

pd_usagemsg="[--help]"

pd_seterrcode \
	"usage"

[ -z "${CHT_BASEDIR}" ] &&
CHT_BASEDIR="/var/opt/cht"

eval set -- "$(pd_parseopts "?s:k:o:x,g" \
"help,colsep:,sep:,separator:,kcol:,\
output:,cols:,columns:,ofs:,\
excel,geo" \
"$@")"

[ $1 -ne 0 ] &&
pd_usage

shift

colsep=
kcol=1
cols=
post=
ofs=

error=

for arg in "$@"
do
	case "${arg}" in
	-\?|--help)
		. "${CHT_BASEDIR}/lib/proklisi/help.sh" 2>/dev/null &&
		pd_exit
		;;
	-s|--colsep|--sep|--separator)
		colsep="$2"
		shift 2
		;;
	-k|--kcol)
		pd_isinteger "$2" 1 || error="yes"
		shift 2
		;;
	-o|--output|--cols|--columns)
		cols="${cols}${2},"
		shift 2
		;;
	--ofs)
		ofs="$2"
		shift 2
		;;
	-x|--excel)
		post="|ssconvert --export-type Gnumeric_Excel:xlsx fd://0 fd://1 2>/dev/null"
		;;
	-g|--geo)
		cols="geoy,geox,kodikos,#FF7F50,"
		ofs=","
		;;
	--)
		shift
		;;
	esac
done
unset arg

[ -n "${error}" ] &&
pd_usage

eval awk \
-i "${PANDORA_BASEDIR}/lib/pandora.awk" \
-i "${CHT_BASEDIR}/lib/dimas.awk" \
-v colsep="${colsep}" \
-v kcol="${kcol}" \
-v cols="${cols}" \
-v ofs="${ofs}" \
-f "${CHT_BASEDIR}/lib/proklisi/expand.awk" $* ${post}
