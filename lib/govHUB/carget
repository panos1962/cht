#!/usr/bin/env bash

###############################################################################@
#
# Copyright (C) 2019 Panos I. Papadopoulos <panos1962_AT_gmail_DOT_com>
#
###############################################################################@
#
# Το παρόν πρόγραμμα είθισται να καλείται εμμέσως, μέσω του προγράμματος
# "govHUB" ως εξής:
#
#	govHUB carget [OPTIONS] [ARGUMENTS]
#
# ή 
#
#	GH carget [OPTIONS] [ARGUMENTS]
#
# Το πρόγραμμα σκοπό έχει να ζητήσει από την πλατφόρμα "govHUB" δεδομένα που
# αφορούν σε οχήματα καταγεγραμμένα στις βάσεις δεδομένων του Υπουργείου
# Οικονομικών. Τα στοιχεία που απαιτούνται προκειμένου να αναζητηθούν και να
# επιστραφούν δεδομένα για κάποιο όχημα είναι ο αριθμός κυκλοφορίας τού
# οχήματος και μια ημερομηνία για την οποία αιτούμαστε δεδομένα οχήματος και
# κατόχων.
#
# Το πρόγραμμα χρησιμοποιείται κυρίως για την εξακρίβωση των στοιχείων κατόχων
# των οχημάτων, προκειμένου να βεβαιωθούν στα αντίστοιχα ΑΦΜ πρόστιμα από
# παραβάσεις ΚΟΚ στις οποίες έχουν υποπέσει τα συγκεκριμένα οχήματα. Επειδή
# οι παραβάσεις χαρακτηρίζονται μονοσήμαντα από κάποιου είδους κωδικό (id,
# primary key κλπ), το πρόγραμμα μπορεί να δέχεται τον κωδικό της παράβασης
# προκειμένου στο output να εκτυπώνεται και ο εν λόγω κωδικός παράβασης, μαζί
# με τα στοιχεία κατόχου.
#
###############################################################################@

pd_tmpmax="1"
. "${PANDORA_BASEDIR:=/var/opt/pandora}/lib/pandora.sh"

pd_seterrcode \
	"fserr" \
	""

tmp1="${pd_tmpname[1]}"
pd_sigtrap

eval set -- "$(pd_parseopts "s:" "script:" "$@")"
[ $1 -ne 0 ] && pd_usage
shift

cat "${CHT_BASEDIR:=/var/opt/cht}/lib/govHUB/carget.js" >"${tmp1}"

error=

for arg in "$@"
do
	case "${arg}" in
	-s|--script)
		cat "${2}" >>"${tmp1}" || error="yes"
		shift 2
		;;
	--)
		shift 1
		;;
	esac
done
unset arg

[ -n "${error}" ] &&
pd_exit "fserr"

echo "carget.init();" >>"${tmp1}"
awk -v script="${tmp1}" -f "${CHT_BASEDIR}/lib/govHUB/carget.awk" "$@"
